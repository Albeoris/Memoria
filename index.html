<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Memoria Catalog Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
    <style>
        body.dark-theme { background-color: #121212; color: #e0e0e0; }
        .dark-theme input, .dark-theme select, .dark-theme textarea { background: #232323; color: #e0e0e0; border-color: #555; }
        .dark-theme .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .dark-theme .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .dark-theme .btn-success { background-color: #198754; border-color: #198754; }
        textarea { resize: vertical; min-height: 60px; overflow-y: hidden; }
        .form-control:focus { box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }

        /* Select2 dark theme override */
        body.dark-theme .select2-container--default .select2-selection--single {
            background-color: #232323 !important;
            color: #e0e0e0 !important;
            border-color: #555 !important;
        }
        body.dark-theme .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e0e0e0 !important;
        }
        body.dark-theme .select2-container--default .select2-dropdown {
            background-color: #232323 !important;
            color: #e0e0e0 !important;
            border-color: #555 !important;
        }
        body.dark-theme .select2-container--default .select2-results__option {
            background-color: #232323 !important;
            color: #e0e0e0 !important;
        }
        body.dark-theme .select2-container--default .select2-results__option--highlighted {
            background-color: #383838 !important;
            color: #fff !important;
        }
        body.dark-theme .select2-search--dropdown .select2-search__field {
            background: #232323 !important;
            color: #e0e0e0 !important;
            border-color: #555 !important;
        }
        
    </style>
</head>
<body class="dark-theme">
<div class="container py-4">
    <h2>Memoria Mod Catalog Editor</h2>
    <div class="mb-3">
        <label>Select Mod:</label>
        <select id="modSelect" class="form-select"></select>
    </div>
    <div class="mb-3">
        <label>Select Sub-mod:</label>
        <select id="submodSelect" class="form-select"></select>
    </div>

    <form id="modForm">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3"><label>Name *</label><input id="name" class="form-control" required></div>
            </div>
            <div class="col-md-6">
                <div class="mb-3"><label>Version *</label><input id="version" class="form-control" required></div>
            </div>
        </div>
        <div class="row" id="mainModFields">
            <div class="col-md-6">
                <div class="mb-3"><label>Installation Path *</label><input id="path" class="form-control" required></div>
            </div>
            <div class="col-md-6">
                <div class="mb-3"><label>Author *</label><input id="author" class="form-control" required></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3"><label>Priority</label><input id="priority" type="number" class="form-control"></div>
            </div>
            <div class="col-md-6">
                <div class="mb-3"><label>Category</label><input id="category" class="form-control"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3"><label>Release Date</label><input id="releaseDate" type="date" class="form-control"></div>
            </div>
            <div class="col-md-6">
                <div class="mb-3"><label>Website</label><input id="website" type="url" class="form-control"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3"><label>Download URL</label><input id="downloadUrl" type="url" class="form-control"></div>
            </div>
            <div class="col-md-6">
                <div class="mb-3"><label>Preview File URL</label><input id="previewFileUrl" type="url" class="form-control"></div>
            </div>
        </div>
        <div class="mb-3"><label>Description *</label><textarea id="description" class="form-control" required rows="4"></textarea></div>
        <div class="mb-3"><label>Patch Notes</label><textarea id="patchNotes" class="form-control" rows="3"></textarea></div>
        <div class="mb-3"><label>Incompatible With</label><input id="incompatibleWith" class="form-control" placeholder="Comma-separated list of mod names"></div>
        <div class="mb-3"><label>Minimum Memoria Version</label><input id="minimumMemoriaVersion" class="form-control" placeholder="YYYY-MM-DD"></div>
        
        <div class="mb-3">
            <button type="button" id="newModBtn" class="btn btn-primary me-2">Create New Mod</button>
            <button type="button" id="newSubmodBtn" class="btn btn-secondary me-2">Create New SubMod</button>
            <button type="submit" id="saveBtn" class="btn btn-success">Save Changes</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script>
    (async function () {
        const xmlUrl = 'https://raw.githubusercontent.com/Albeoris/Memoria/main/Memoria.Launcher/Catalogs/MemoriaCatalog.xml';
        const xmlText = await fetch(xmlUrl).then(r => r.text());
        const xmlDoc = new DOMParser().parseFromString(xmlText, 'application/xml');

        const mods = Array.from(xmlDoc.querySelectorAll('ModCatalog > Mod'));
        mods.sort((a, b) => a.querySelector('n').textContent.localeCompare(b.querySelector('n').textContent));

        const modSelect = $('#modSelect');
        const submodSelect = $('#submodSelect');

        mods.forEach(mod => modSelect.append(new Option(mod.querySelector('n').textContent)));

        modSelect.select2();
        submodSelect.select2();

        function autosizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function fillForm(modElement, isSubmod) {
            // Clear all fields first
            $('#modForm input, #modForm textarea').val('');
            
            // Basic fields
            $('#name').val(modElement.querySelector('n')?.textContent || '');
            $('#version').val(modElement.querySelector('Version')?.textContent || '');
            $('#description').val(modElement.querySelector('Description')?.textContent || '');
            $('#patchNotes').val(modElement.querySelector('PatchNotes')?.textContent || '');
            
            // Optional fields
            $('#priority').val(modElement.querySelector('Priority')?.textContent || '');
            $('#category').val(modElement.querySelector('Category')?.textContent || '');
            $('#website').val(modElement.querySelector('Website')?.textContent || '');
            $('#downloadUrl').val(modElement.querySelector('DownloadUrl')?.textContent || '');
            $('#previewFileUrl').val(modElement.querySelector('PreviewFileUrl')?.textContent || '');
            $('#incompatibleWith').val(modElement.querySelector('IncompatibleWith')?.textContent || '');
            $('#minimumMemoriaVersion').val(modElement.querySelector('MinimumMemoriaVersion')?.textContent || '');
            
            // Format date if present
            const releaseDate = modElement.querySelector('ReleaseDate')?.textContent;
            if (releaseDate) {
                // Try to parse the date and format it for HTML date input
                try {
                    const date = new Date(releaseDate);
                    if (!isNaN(date.getTime())) {
                        $('#releaseDate').val(date.toISOString().split('T')[0]);
                    }
                } catch (e) {
                    $('#releaseDate').val('');
                }
            }

            // Show/hide main mod fields
            $('#mainModFields').toggle(!isSubmod);

            // Main mod specific fields
            if (!isSubmod) {
                $('#path').val(modElement.querySelector('InstallationPath')?.textContent || '');
                $('#author').val(modElement.querySelector('Author')?.textContent || '');
            }
            
            // Auto-resize textareas
            autosizeTextarea(document.getElementById('description'));
            autosizeTextarea(document.getElementById('patchNotes'));
        }

        function updateSubmods() {
            submodSelect.empty().append(new Option('Main'));
            const mod = mods[modSelect.prop('selectedIndex')];
            const submods = mod.querySelectorAll('SubMod');
            submods.forEach(submod => {
                submodSelect.append(new Option(submod.querySelector('n').textContent));
            });
            fillForm(mod, false);
        }

        modSelect.on('change', updateSubmods);
        updateSubmods();

        submodSelect.on('change', () => {
            const mod = mods[modSelect.prop('selectedIndex')];
            const submods = mod.querySelectorAll('SubMod');
            const submodIndex = submodSelect.prop('selectedIndex') - 1;
            const isSubmod = submodIndex >= 0;
            fillForm(isSubmod ? submods[submodIndex] : mod, isSubmod);
        });

        // Auto-resize textareas
        $('textarea').on('input', function() {
            autosizeTextarea(this);
        });

        $('#saveBtn').click(e => {
            e.preventDefault();
            
            // Enhanced validation
            const form = document.getElementById('modForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Additional validation for required fields when not empty
            const name = $('#name').val().trim();
            const version = $('#version').val().trim();
            const description = $('#description').val().trim();
            
            if (!name || !version || !description) {
                alert('Name, Version, and Description are required and cannot be empty or whitespace only.');
                return;
            }
            
            // Check if we're editing a submod or main mod
            const isSubmod = submodSelect.prop('selectedIndex') > 0;
            if (!isSubmod) {
                const path = $('#path').val().trim();
                const author = $('#author').val().trim();
                if (!path || !author) {
                    alert('Installation Path and Author are required for main mods.');
                    return;
                }
            }
            
            alert('Save action would trigger GitHub Actions or API call here. Implementation coming next...');
        });
        
        // New mod button
        $('#newModBtn').click(() => {
            if (confirm('Create a new mod? This will clear the current form.')) {
                // Clear form and set up for new mod
                $('#modForm input, #modForm textarea').val('');
                $('#mainModFields').show();
                $('#modSelect').val(null).trigger('change.select2');
                $('#submodSelect').empty().append(new Option('Main')).val(null).trigger('change.select2');
                $('#name').focus();
            }
        });
        
        // New submod button
        $('#newSubmodBtn').click(() => {
            const selectedModIndex = modSelect.prop('selectedIndex');
            if (selectedModIndex < 0) {
                alert('Please select a parent mod first.');
                return;
            }
            
            if (confirm('Create a new submod for the selected mod? This will clear the current form.')) {
                // Clear form and set up for new submod
                $('#modForm input, #modForm textarea').val('');
                $('#mainModFields').hide();
                // Add a temporary "New SubMod" option
                const newOption = new Option('(New SubMod)', 'new-submod');
                submodSelect.append(newOption);
                submodSelect.val('new-submod').trigger('change.select2');
                $('#name').focus();
            }
        });
    })();
</script>
</body>
</html>